#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <unistd.h>
#include "hacking.h"

void usage(char *program_name, char *filename) {
    printf("Usage: %s <data to add to %s>\n", program_name, filename);
    exit(0);
}

// Declare functions in hacking.h module
void fatal(char *);
void *error_checked_memory_allocator(unsigned int);

int main(int argc, char const *argv[])
{
    int userid, file_descriptor;
    char *buffer, *datafile;

    buffer = (char *) error_checked_memory_allocator(100);
    datafile = (char *) error_checked_memory_allocator(20);

    strcpy(datafile, "./notes.txt");

    // Check for correct amount of cmd line arguments
    if (argc < 2) {
        usage(argv[0], datafile);
    }

    strcpy(buffer, argv[1]);

    printf("[DEBUG] buffer  @ %p: \'%s\'\n", buffer, buffer);
    printf("[DEBUG] datafile  @ %p: \'%s\'\n", datafile, datafile);

    // Add read and write permissions for user while opening file
    file_descriptor = open(datafile, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);

    if (file_descriptor == -1) {
        fatal("In main() while opening file");
    }

    printf("[DEBUG] file_descriptor is %d\n", file_descriptor);

    userid = getuid();

    if (write(file_descriptor, &userid, 4) == -1) { // Write user id before note data
        fatal("In main() while writing userid to file");
    }

    write(file_descriptor, "\n", 1);

    if (write(file_descriptor, buffer, strlen(buffer)) == -1) { // Write the noet
        fatal("In main() while writing buffer to file");
    }

    write(file_descriptor, "\n", 1);

    // Closing file
    if (close(file_descriptor) == -1) {
        fatal("In main() while closing file");
    }

    printf("Note hasbeen saved\n");

    free(buffer);
    free(datafile);
}
